C51 COMPILER V9.60.7.0   MAIN                                                              11/07/2025 22:46:32 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Software\Keil\Core\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Li
                    -stings\main.lst) OBJECT(.\Objects\main.obj)

line level    source

   1          #include <REGX52.H>
   2          #include "intrins.h"
   3          #include "Delay.h"
   4          #include "LCD1602.h"
   5          #include "DS1302.h"
   6          #include "Key.h"
   7          #include "DS18B20.h"
   8          #include "Timer0.h"
   9          
  10          
  11          
  12          volatile unsigned int StopwatchTime = 0; // 被中断例程更新，声明为 volatile
  13          //闹钟时间设置
  14          char AlarmTime[] = {25,01,01,11,31,59,3}; //年、月、日、 时、分、秒
  15          //标志全局变量
  16          unsigned char KeyNum, MODE, TimeSetSelect, AlarmFlag, BuzzerState, BuzzerCount, StopwatchMode;
  17          volatile unsigned char TimeSetFlashFlag = 0; // 在定时器中断中切换，声明为 volatile
  18          volatile unsigned char StopwatchState = 0;   // 由主循环和中断共同使用，声明为 volatile
  19          
  20          float T;//温度
  21          #define Buzzer P1_5
  22          
  23          
  24          void StopwatchControl();//秒表按键功能 
  25          void CheckAlarm();//闹钟功能函数声明
  26          unsigned char CalculateWeekday(int year, int month, int day);//星期计算函数声明
  27          void TimeSet(char* TimeArray,unsigned char* SelectPtr);//时间设置功能
  28          void TimeShow(void);//时间显示功能
  29          void ShowStopwatch();// 显示秒表计时值
  30          
  31          
  32          
  33          void main()
  34          {
  35   1              LCD_Init();
  36   1              DS1302_Init();
  37   1              DS18B20_ConvertT();     
  38   1              DS18B20_Init(); 
  39   1              Timer0Init();
  40   1              LCD_ShowString(1,1,"  -  -  ");//静态字符初始化显示
  41   1              LCD_ShowString(2,1,"  :  :  ");
  42   1              DS1302_Time[6] = CalculateWeekday(DS1302_Time[0], DS1302_Time[1], DS1302_Time[2]);
  43   1              DS1302_SetTime();
  44   1              
  45   1              while(1)
  46   1              {
  47   2                      KeyNum=Key();//读取键码
  48   2                      if(KeyNum==1)//按键1按下
  49   2                      {
  50   3                              if(MODE==0){MODE=1;TimeSetSelect=0;}//功能切换
  51   3                              else if(MODE==1){MODE=0;DS1302_SetTime();}
  52   3                              else if(MODE==3){MODE=0;}
  53   3                      }
  54   2                      if(KeyNum==5){
C51 COMPILER V9.60.7.0   MAIN                                                              11/07/2025 22:46:32 PAGE 2   

  55   3                              if(MODE==0){
  56   4                                      MODE=2;
  57   4                                      LCD_Init(); // 切换到秒表模式时初始化LCD
  58   4                                      LCD_ShowString(1,1,"Stopwatch");
  59   4                                      StopwatchTime = 0; // 重置秒表时间
  60   4                                      StopwatchState = 0; // 重置秒表状态
  61   4                              }
  62   3                              else if(MODE==2){
  63   4                                      MODE=3;
  64   4                                      LCD_Init();
  65   4                                      LCD_ShowString(1,1,"  -  -  ");
  66   4                                      LCD_ShowString(2,1,"  :  :  ");
  67   4                              }
  68   3                              else if(MODE == 3)
  69   3                              {
  70   4                                      MODE=0;
  71   4                                      LCD_Init();
  72   4                                      LCD_ShowString(1,1,"  -  -  ");
  73   4                                      LCD_ShowString(2,1,"  :  :  ");
  74   4                              }
  75   3                              
  76   3                      }
  77   2                      switch(MODE)//根据不同的功能执行不同的函数
  78   2                      {
  79   3                              case 0:TimeShow();CheckAlarm();Show_Temperature();break;
  80   3                              case 1:TimeSet(DS1302_Time,&TimeSetSelect);break;
  81   3                              case 2:StopwatchControl();break;
  82   3                              case 3:TimeSet(AlarmTime,&TimeSetSelect);LCD_ShowString(2, 10, "W:");LCD_ShowString(1, 10, "SETTING");b
             -reak;
  83   3                      }
  84   2                      if (BuzzerState) {
  85   3                  BuzzerCount++;
  86   3                  if (BuzzerCount >= 50) { // 蜂鸣器鸣叫 5 秒（100ms * 10）
  87   4                      BuzzerState = 0;    // 关闭蜂鸣器
  88   4                      BuzzerCount = 0;
  89   4                                      Buzzer = 0;
  90   4                  }
  91   3                  Buzzer = !Buzzer;
  92   3                              Delay(5);
  93   3                              Buzzer = !Buzzer;
  94   3                              Delay(5);
  95   3                              Buzzer = !Buzzer;
  96   3                              Delay(5);// 蜂鸣器状态取反
  97   3              } else {
  98   3                  Buzzer = 0; // 关闭蜂鸣器
  99   3              }
 100   2      }
 101   1      }
 102          
 103          
 104          //秒表按键功能
 105          void StopwatchControl() { 
 106   1          // 按键2：开始/暂停秒表
 107   1          if (KeyNum == 6) {
 108   2              StopwatchState = !StopwatchState;
 109   2          }
 110   1          // 按键3：清零秒表
 111   1          if (KeyNum == 7) {
 112   2              StopwatchTime = 0;
 113   2              StopwatchState = 0;
 114   2          }
 115   1          // 显示秒表计时值
C51 COMPILER V9.60.7.0   MAIN                                                              11/07/2025 22:46:32 PAGE 3   

 116   1          ShowStopwatch();
 117   1      }
 118          
 119          
 120          // 显示秒表计时值
 121          void ShowStopwatch() {
 122   1              unsigned int timeCopy;
 123   1              unsigned int seconds, milliseconds;
 124   1              // StopwatchTime 是 16 位，会被中断例程更新；在读取时短暂禁中断以保证原子性
 125   1              EA = 0; // 关总中断
 126   1              timeCopy = StopwatchTime;
 127   1              EA = 1; // 开总中断
 128   1      
 129   1              seconds = timeCopy / 1000; // 计算秒
 130   1              milliseconds = timeCopy % 1000; // 计算毫秒
 131   1      
 132   1              LCD_ShowNum(2, 1, seconds / 60, 2); // 显示分钟
 133   1              LCD_ShowChar(2, 3, ':');           // 显示冒号
 134   1              LCD_ShowNum(2, 4, seconds % 60, 2); // 显示秒
 135   1              LCD_ShowChar(2, 6, '.');           // 显示小数点
 136   1              LCD_ShowNum(2, 7, milliseconds / 10, 2); // 显示毫秒（取前两位）
 137   1      }
 138          
 139          
 140          void TimeShow(void)//时间显示功能
 141          {       
 142   1              DS1302_ReadTime();//读取时间
 143   1              LCD_ShowNum(1,1,DS1302_Time[0],2);//显示年
 144   1              LCD_ShowNum(1,4,DS1302_Time[1],2);//显示月
 145   1              LCD_ShowNum(1,7,DS1302_Time[2],2);//显示日
 146   1              LCD_ShowNum(2,1,DS1302_Time[3],2);//显示时
 147   1              LCD_ShowNum(2,4,DS1302_Time[4],2);//显示分
 148   1              LCD_ShowNum(2,7,DS1302_Time[5],2);//显示秒
 149   1              LCD_ShowString(2, 10, "W:");          // 显示星期
 150   1              LCD_ShowNum(2, 12, DS1302_Time[6], 1); // 显示星期值
 151   1      }
 152          
 153          //时间设置功能
 154          void TimeSet(char* TimeArray,unsigned char* SelectPtr){
 155   1          
 156   1              if(KeyNum==2)//按键2按下
 157   1              {
 158   2                      (*SelectPtr)++;//设置选择位加1
 159   2                      *SelectPtr%=7;//越界清零
 160   2              }
 161   1              if(KeyNum==3)//按键3按下
 162   1              {
 163   2                      TimeArray[*SelectPtr]++;//时间设置位数值加1
 164   2                       
 165   2                      if(TimeArray[0]>99){TimeArray[0]=0;}//年越界判断
 166   2                      if(TimeArray[1]>12){TimeArray[1]=1;}//月越界判断
 167   2      
 168   2                      if( TimeArray[1]==1 || TimeArray[1]==3 || TimeArray[1]==5 || TimeArray[1]==7 || 
 169   2                              TimeArray[1]==8 || TimeArray[1]==10 || TimeArray[1]==12)//日越界判断
 170   2                      {
 171   3                              if(TimeArray[2]>31){TimeArray[2]=1;}//大月
 172   3                      }
 173   2                      else if(TimeArray[1]==4 || TimeArray[1]==6 || TimeArray[1]==9 || TimeArray[1]==11)
 174   2                      {
 175   3                              if(TimeArray[2]>30){TimeArray[2]=1;}//小月
 176   3                      }
 177   2                      else if(TimeArray[1]==2)
C51 COMPILER V9.60.7.0   MAIN                                                              11/07/2025 22:46:32 PAGE 4   

 178   2                      {
 179   3                              if(TimeArray[0]%4==0)
 180   3                              {
 181   4                                      if(TimeArray[2]>29){TimeArray[2]=1;}//闰年2月
 182   4                              }
 183   3                              else
 184   3                              {
 185   4                                      if(TimeArray[2]>28){TimeArray[2]=1;}//平年2月
 186   4                              }
 187   3                      }
 188   2                      TimeArray[6] = CalculateWeekday(TimeArray[0], TimeArray[1], TimeArray[2]);//更新星期
 189   2                      if(TimeArray[3]>23){TimeArray[3]=0;}//时越界判断
 190   2                      if(TimeArray[4]>59){TimeArray[4]=0;}//分越界判断
 191   2                      if(TimeArray[5]>59){TimeArray[5]=0;}//秒越界判断
 192   2                      if(TimeArray[6]>6){TimeArray[6]=0;}//星期越界判断
 193   2      
 194   2              }
 195   1              if(KeyNum==4)//按键4按下
 196   1              {
 197   2                      TimeArray[*SelectPtr]--;//时间设置位数值减1
 198   2                      if(TimeArray[0]<0){TimeArray[0]=99;}//年越界判断
 199   2                      if(TimeArray[1]<1){TimeArray[1]=12;}//月越界判断
 200   2                      if( TimeArray[1]==1 || TimeArray[1]==3 || TimeArray[1]==5 || TimeArray[1]==7 || 
 201   2                              TimeArray[1]==8 || TimeArray[1]==10 || TimeArray[1]==12)//日越界判断
 202   2                      {
 203   3                              if(TimeArray[2]<1){TimeArray[2]=31;}//大月
 204   3                              if(TimeArray[2]>31){TimeArray[2]=1;}
 205   3                      }
 206   2                      else if(TimeArray[1]==4 || TimeArray[1]==6 || TimeArray[1]==9 || TimeArray[1]==11)
 207   2                      {
 208   3                              if(TimeArray[2]<1){TimeArray[2]=30;}//小月
 209   3                              if(TimeArray[2]>30){TimeArray[2]=1;}
 210   3                      }
 211   2                      else if(TimeArray[1]==2)
 212   2                      {
 213   3                              if(TimeArray[0]%4==0)
 214   3                              {
 215   4                                      if(TimeArray[2]<1){TimeArray[2]=29;}//闰年2月
 216   4                                      if(TimeArray[2]>29){TimeArray[2]=1;}
 217   4                              }
 218   3                              else
 219   3                              {
 220   4                                      if(TimeArray[2]<1){TimeArray[2]=28;}//平年2月
 221   4                                      if(TimeArray[2]>28){TimeArray[2]=1;}
 222   4                              }
 223   3                      }
 224   2                      if(TimeArray[3]<0){TimeArray[3]=23;}//时越界判断
 225   2                      if(TimeArray[4]<0){TimeArray[4]=59;}//分越界判断
 226   2                      if(TimeArray[5]<0){TimeArray[5]=59;}//秒越界判断
 227   2                      if(TimeArray[6]<0){TimeArray[6]=6;}//星期越界判断
 228   2                      TimeArray[6] = CalculateWeekday(TimeArray[0], TimeArray[1], TimeArray[2]);
 229   2              }
 230   1              //更新显示，根据TimeSetSelect和TimeSetFlashFlag判断可完成闪烁功能
 231   1              if(*SelectPtr==0 && TimeSetFlashFlag==1){LCD_ShowString(1,1,"  ");}
 232   1              else {LCD_ShowNum(1,1,TimeArray[0],2);}
 233   1              if(*SelectPtr==1 && TimeSetFlashFlag==1){LCD_ShowString(1,4,"  ");}
 234   1              else {LCD_ShowNum(1,4,TimeArray[1],2);}
 235   1              if(*SelectPtr==2 && TimeSetFlashFlag==1){LCD_ShowString(1,7,"  ");}
 236   1              else {LCD_ShowNum(1,7,TimeArray[2],2);}
 237   1              if(*SelectPtr==3 && TimeSetFlashFlag==1){LCD_ShowString(2,1,"  ");}
 238   1              else {LCD_ShowNum(2,1,TimeArray[3],2);}
 239   1              if(*SelectPtr==4 && TimeSetFlashFlag==1){LCD_ShowString(2,4,"  ");}
C51 COMPILER V9.60.7.0   MAIN                                                              11/07/2025 22:46:32 PAGE 5   

 240   1              else {LCD_ShowNum(2,4,TimeArray[4],2);}
 241   1              if(*SelectPtr==5 && TimeSetFlashFlag==1){LCD_ShowString(2,7,"  ");}
 242   1              else {LCD_ShowNum(2,7,TimeArray[5],2);}
 243   1              if(*SelectPtr==6 && TimeSetFlashFlag==1){LCD_ShowString(2,12,"  ");}
 244   1              else {LCD_ShowNum(2,12,TimeArray[6],1);}
 245   1      }
 246          
 247          
 248          //闹钟功能函数实现
 249          void CheckAlarm() {
 250   1          if (DS1302_Time[0] == AlarmTime[0] && 
 251   1              DS1302_Time[1] == AlarmTime[1] && 
 252   1              DS1302_Time[2] == AlarmTime[2] &&
 253   1                      DS1302_Time[3] == AlarmTime[3] &&
 254   1                      DS1302_Time[4] == AlarmTime[4] &&
 255   1                      DS1302_Time[5] == AlarmTime[5] &&
 256   1                      DS1302_Time[6] == AlarmTime[6]) {
 257   2              AlarmFlag = 1; // 触发闹钟
 258   2                      BuzzerState = 1;
 259   2                      }else {
 260   2              AlarmFlag = 0; // 关闭闹钟
 261   2          }
 262   1      }
 263          
 264          
 265          //星期计算函数实现
 266          unsigned char CalculateWeekday(int year, int month, int day) {
 267   1              unsigned char weekday;
 268   1          if (month < 3) {
 269   2              month += 12;
 270   2              year--;
 271   2          }
 272   1          weekday = (day + 2 * month + 3 * (month + 1) / 5 + year + year / 4 - year / 100 + year / 400) % 7;
 273   1          return (weekday + 1);
 274   1      }
 275          
 276          
 277          void Timer0_Routine() interrupt 1
 278          {
 279   1              static unsigned int T0Count;
 280   1              static unsigned char station_toggle;
 281   1              TL0 = 0x18;             //设置定时初值
 282   1              TH0 = 0xFC;             //设置定时初值
 283   1              T0Count++;
 284   1              if(T0Count>=100)//每100ms进入一次
 285   1              {       
 286   2                      T0Count=0;
 287   2                      station_toggle++;
 288   2                      if (station_toggle>=4)
 289   2                      {
 290   3                              station_toggle = 0;
 291   3                              TimeSetFlashFlag=!TimeSetFlashFlag;//闪烁标志位取反
 292   3                      }
 293   2                      if (StopwatchState) {
 294   3                  StopwatchTime += 100; // 增加 100ms
 295   3              }
 296   2              }
 297   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2174    ----
C51 COMPILER V9.60.7.0   MAIN                                                              11/07/2025 22:46:32 PAGE 6   

   CONSTANT SIZE    =     42    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     25      12
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
