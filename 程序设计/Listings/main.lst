C51 COMPILER V9.60.7.0   MAIN                                                              01/01/2025 20:09:50 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Users\lczhu\software\keil\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEX
                    -TEND PRINT(.\Listings\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          #include <REGX52.H>
   2          #include "intrins.h"
   3          
   4          
   5          //1602å¼•è„šé…ç½®
   6          #define LCD_RS P2_6
   7          #define LCD_RW P2_5
   8          #define LCD_EN P2_7
   9          #define LCD_DataPort P0
  10          //1302å¼•è„šé…ç½®
  11          #define DS1302_SCLK P3_6
  12          #define DS1302_IO P3_4
  13          #define DS1302_CE P3_5
  14          //18B20å¼•è„šé…ç½®
  15          #define OneWire_DQ P3_7
  16          //1302å¯„å­˜å™¨å†™å…¥åœ°å€/æŒ‡ä»¤å®šä¹‰
  17          #define DS1302_SECOND   0x80
  18          #define DS1302_MINUTE   0x82
  19          #define DS1302_HOUR     0x84
  20          #define DS1302_DATE     0x86
  21          #define DS1302_MONTH    0x88
  22          #define DS1302_DAY      0x8A
  23          #define DS1302_YEAR     0x8C
  24          #define DS1302_WP     0x8E
  25          //ç‹¬ç«‹æŒ‰é”®å‡½æ•°å£°æ˜
  26          unsigned char Key();
  27          //å»¶æ—¶å‡½æ•°å£°æ˜
  28          void Delay(unsigned int xms);
  29          //T0å®šæ—¶å™¨åˆå§‹åŒ–å‡½æ•°å£°æ˜
  30          void Timer0Init(void);
  31          //é—¹é’ŸåŠŸèƒ½å‡½æ•°å£°æ˜
  32          void CheckAlarm();
  33          //1302å‡½æ•°å£°æ˜
  34          void DS1302_Init(void);
  35          void DS1302_WriteByte(unsigned char Command,Data);
  36          unsigned char DS1302_ReadByte(unsigned char Command);
  37          void DS1302_SetTime(void);
  38          void DS1302_ReadTime(void);
  39          //18B20å‡½æ•°å£°æ˜
  40          void DS18B20_ConvertT(void);
  41          float DS18B20_ReadT(void);
  42          void DS18B20_Init(void);
  43          //å•æ€»çº¿å‡½æ•°å£°æ˜
  44          unsigned char OneWire_Init(void);
  45          void OneWire_SendBit(unsigned char Bit);
  46          unsigned char OneWire_ReceiveBit(void);
  47          void OneWire_SendByte(unsigned char Byte);
  48          unsigned char OneWire_ReceiveByte(void);
  49          //DS18B20æŒ‡ä»¤
  50          #define DS18B20_SKIP_ROM      0xCC
  51          #define DS18B20_CONVERT_T     0x44
  52          #define DS18B20_READ_SCRATCHPAD   0xBE
  53          //æ—¶é—´æ•°ç»„ï¼Œç´¢å¼•0~6åˆ†åˆ«ä¸ºå¹´ã€æœˆã€æ—¥ã€æ—¶ã€åˆ†ã€ç§’ã€æ˜ŸæœŸï¼Œè®¾ç½®ä¸ºæœ‰ç¬¦å·çš„ä¾¿äº
             -<0çš„åˆ¤æ–­
C51 COMPILER V9.60.7.0   MAIN                                                              01/01/2025 20:09:50 PAGE 2   

  54          char DS1302_Time[]={25,01,01,11,31,55,3};
  55          //é—¹é’Ÿæ—¶é—´è®¾ç½®
  56          char AlarmTime[] = {25,01,01,11,31,59,3}; //å¹´ã€æœˆã€æ—¥ã€ æ—¶ã€åˆ†ã€ç§’
  57          //æ ‡å¿—å…¨å±€å˜é‡
  58          unsigned char KeyNum,MODE,TimeSetSelect,TimeSetFlashFlag,AlarmFlag,BuzzerState,BuzzerCount,StopwatchMode,S
             -topwatchState;
  59          unsigned int StopwatchTime = 0;
  60          float T;//æ¸©åº¦
  61          #define Buzzer P1_5
  62          //æ˜ŸæœŸè®¡ç®—å‡½æ•°å£°æ˜
  63          unsigned char CalculateWeekday(int year, int month, int day);
  64          //1602å‡½æ•°å£°æ˜
  65          void LCD_Init();
  66          void LCD_ShowChar(unsigned char Line,unsigned char Column,char Char);
  67          void LCD_ShowString(unsigned char Line,unsigned char Column,char *String);
  68          void LCD_ShowNum(unsigned char Line,unsigned char Column,unsigned int Number,unsigned char Length);
  69          int LCD_Pow(int X,int Y);
  70          //æ—¶é—´å‡½æ•°å£°æ˜
  71          void TimeSet(char* TimeArray,unsigned char* SelectPtr);//æ—¶é—´è®¾ç½®åŠŸèƒ½
  72          void TimeShow(void);//æ—¶é—´æ˜¾ç¤ºåŠŸèƒ½
  73          //ç§’è¡¨åŠŸèƒ½å‡½æ•°å£°æ˜
  74          void ShowStopwatch();// æ˜¾ç¤ºç§’è¡¨è®¡æ—¶å€¼
  75          void StopwatchControl();//ç§’è¡¨æŒ‰é”®åŠŸèƒ½ 
  76          //æ¸©åº¦æ˜¾ç¤ºå‡½æ•°å£°æ˜
  77          void Show_Temperature();
  78          
  79          
  80          
  81          void main()
  82          {
  83   1        LCD_Init();
  84   1        DS1302_Init();
  85   1        DS18B20_ConvertT(); 
  86   1        DS18B20_Init(); 
  87   1        Timer0Init();
  88   1        LCD_ShowString(1,1,"  -  -  ");//é™æ€å­—ç¬¦åˆå§‹åŒ–æ˜¾ç¤º
  89   1        LCD_ShowString(2,1,"  :  :  ");
  90   1        DS1302_Time[6] = CalculateWeekday(DS1302_Time[0], DS1302_Time[1], DS1302_Time[2]);
  91   1        DS1302_SetTime();
  92   1        
  93   1        while(1)
  94   1        {
  95   2          KeyNum=Key();//è¯»å–é”®ç 
  96   2          if(KeyNum==1)//æŒ‰é”®1æŒ‰ä¸‹
  97   2          {
  98   3            if(MODE==0){MODE=1;TimeSetSelect=0;}//åŠŸèƒ½åˆ‡æ¢
  99   3            else if(MODE==1){MODE=0;DS1302_SetTime();}
 100   3            else if(MODE==3){MODE=0;}
 101   3          }
 102   2          if(KeyNum==5){
 103   3            if(MODE==0){
 104   4              MODE=2;
 105   4              LCD_Init(); // åˆ‡æ¢åˆ°ç§’è¡¨æ¨¡å¼æ—¶åˆå§‹åŒ–LCD
 106   4              LCD_ShowString(1,1,"Stopwatch");
 107   4              StopwatchTime = 0; // é‡ç½®ç§’è¡¨æ—¶é—´
 108   4              StopwatchState = 0; // é‡ç½®ç§’è¡¨çŠ¶æ€
 109   4            }
 110   3            else if(MODE==2){
 111   4              MODE=3;
 112   4              LCD_Init();
 113   4              LCD_ShowString(1,1,"  -  -  ");
 114   4              LCD_ShowString(2,1,"  :  :  ");
C51 COMPILER V9.60.7.0   MAIN                                                              01/01/2025 20:09:50 PAGE 3   

 115   4            }
 116   3            else if(MODE == 3)
 117   3            {
 118   4              MODE=0;
 119   4              LCD_Init();
 120   4              LCD_ShowString(1,1,"  -  -  ");
 121   4              LCD_ShowString(2,1,"  :  :  ");
 122   4            }
 123   3            
 124   3          }
 125   2          switch(MODE)//æ ¹æ®ä¸åŒçš„åŠŸèƒ½æ‰§è¡Œä¸åŒçš„å‡½æ•°
 126   2          {
 127   3            case 0:TimeShow();CheckAlarm();Show_Temperature();break;
 128   3            case 1:TimeSet(DS1302_Time,&TimeSetSelect);break;
 129   3            case 2:StopwatchControl();break;
 130   3            case 3:TimeSet(AlarmTime,&TimeSetSelect);LCD_ShowString(2, 10, "W:");LCD_ShowString(1, 10, "SETTING");b
             -reak;
 131   3          }
 132   2          if (BuzzerState) {
 133   3                  BuzzerCount++;
 134   3                  if (BuzzerCount >= 50) { // èœ‚é¸£å™¨é¸£å« 5 ç§’ï¼ˆ100ms * 10ï¼‰
 135   4                      BuzzerState = 0;    // å…³é—­èœ‚é¸£å™¨
 136   4                      BuzzerCount = 0;
 137   4              Buzzer = 0;
 138   4                  }
 139   3                  Buzzer = !Buzzer;
 140   3            Delay(5);
 141   3            Buzzer = !Buzzer;
 142   3            Delay(5);
 143   3            Buzzer = !Buzzer;
 144   3            Delay(5);// èœ‚é¸£å™¨çŠ¶æ€å–å
 145   3              } else {
 146   3                  Buzzer = 0; // å…³é—­èœ‚é¸£å™¨
 147   3              }
 148   2      }
 149   1      }
 150          
 151          void Show_Temperature(){
 152   1        DS18B20_ConvertT(); //è½¬æ¢æ¸©åº¦
 153   1        T=DS18B20_ReadT();  //è¯»å–æ¸©åº¦
 154   1        //Delay(500);
 155   1        if(T<0)       //å¦‚æœæ¸©åº¦å°äº0
 156   1        {
 157   2          LCD_ShowChar(1,10,'-'); //æ˜¾ç¤ºè´Ÿå·
 158   2          T=-T;     //å°†æ¸©åº¦å˜ä¸ºæ­£æ•°
 159   2        }
 160   1        else        //å¦‚æœæ¸©åº¦å¤§äºç­‰äº0
 161   1        {
 162   2          LCD_ShowChar(1,10,'+'); //æ˜¾ç¤ºæ­£å·
 163   2        }
 164   1        LCD_ShowNum(1,11,(unsigned int)T,2);    //æ˜¾ç¤ºæ¸©åº¦æ•´æ•°éƒ¨åˆ†
 165   1        LCD_ShowChar(1,13,'.');   //æ˜¾ç¤ºå°æ•°ç‚¹
 166   1        LCD_ShowNum(1,14,(unsigned int)(T*100)%100,2);//æ˜¾ç¤ºæ¸©åº¦å°æ•°éƒ¨åˆ†
 167   1      }
 168          //ç§’è¡¨æŒ‰é”®åŠŸèƒ½
 169          void StopwatchControl() { 
 170   1          // æŒ‰é”®2ï¼šå¼€å§‹/æš‚åœç§’è¡¨
 171   1          if (KeyNum == 6) {
 172   2              StopwatchState = !StopwatchState;
 173   2          }
 174   1          // æŒ‰é”®3ï¼šæ¸…é›¶ç§’è¡¨
 175   1          if (KeyNum == 7) {
C51 COMPILER V9.60.7.0   MAIN                                                              01/01/2025 20:09:50 PAGE 4   

 176   2              StopwatchTime = 0;
 177   2              StopwatchState = 0;
 178   2          }
 179   1          // æ˜¾ç¤ºç§’è¡¨è®¡æ—¶å€¼
 180   1          ShowStopwatch();
 181   1      }
 182          // æ˜¾ç¤ºç§’è¡¨è®¡æ—¶å€¼
 183          void ShowStopwatch() {
 184   1          unsigned int seconds = StopwatchTime / 1000; // è®¡ç®—ç§’
 185   1          unsigned int milliseconds = StopwatchTime % 1000; // è®¡ç®—æ¯«ç§’
 186   1      
 187   1          LCD_ShowNum(2, 1, seconds / 60, 2); // æ˜¾ç¤ºåˆ†é’Ÿ
 188   1          LCD_ShowChar(2, 3, ':');           // æ˜¾ç¤ºå†’å·
 189   1          LCD_ShowNum(2, 4, seconds % 60, 2); // æ˜¾ç¤ºç§’
 190   1          LCD_ShowChar(2, 6, '.');           // æ˜¾ç¤ºå°æ•°ç‚¹
 191   1          LCD_ShowNum(2, 7, milliseconds / 10, 2); // æ˜¾ç¤ºæ¯«ç§’ï¼ˆå–å‰ä¸¤ä½ï¼‰
 192   1      }
 193          void TimeShow(void)//æ—¶é—´æ˜¾ç¤ºåŠŸèƒ½
 194          { 
 195   1        DS1302_ReadTime();//è¯»å–æ—¶é—´
 196   1        LCD_ShowNum(1,1,DS1302_Time[0],2);//æ˜¾ç¤ºå¹´
 197   1        LCD_ShowNum(1,4,DS1302_Time[1],2);//æ˜¾ç¤ºæœˆ
 198   1        LCD_ShowNum(1,7,DS1302_Time[2],2);//æ˜¾ç¤ºæ—¥
 199   1        LCD_ShowNum(2,1,DS1302_Time[3],2);//æ˜¾ç¤ºæ—¶
 200   1        LCD_ShowNum(2,4,DS1302_Time[4],2);//æ˜¾ç¤ºåˆ†
 201   1        LCD_ShowNum(2,7,DS1302_Time[5],2);//æ˜¾ç¤ºç§’
 202   1        LCD_ShowString(2, 10, "W:");          // æ˜¾ç¤ºæ˜ŸæœŸ
 203   1        LCD_ShowNum(2, 12, DS1302_Time[6], 1); // æ˜¾ç¤ºæ˜ŸæœŸå€¼
 204   1      }
 205          
 206          void TimeSet(char* TimeArray,unsigned char* SelectPtr)//æ—¶é—´è®¾ç½®åŠŸèƒ½
 207          {
 208   1        if(KeyNum==2)//æŒ‰é”®2æŒ‰ä¸‹
 209   1        {
 210   2          (*SelectPtr)++;//è®¾ç½®é€‰æ‹©ä½åŠ 1
 211   2          *SelectPtr%=7;//è¶Šç•Œæ¸…é›¶
 212   2        }
 213   1        if(KeyNum==3)//æŒ‰é”®3æŒ‰ä¸‹
 214   1        {
 215   2          TimeArray[*SelectPtr]++;//æ—¶é—´è®¾ç½®ä½æ•°å€¼åŠ 1
 216   2           
 217   2          if(TimeArray[0]>99){TimeArray[0]=0;}//å¹´è¶Šç•Œåˆ¤æ–­
 218   2          if(TimeArray[1]>12){TimeArray[1]=1;}//æœˆè¶Šç•Œåˆ¤æ–­
 219   2      
 220   2          if( TimeArray[1]==1 || TimeArray[1]==3 || TimeArray[1]==5 || TimeArray[1]==7 || 
 221   2            TimeArray[1]==8 || TimeArray[1]==10 || TimeArray[1]==12)//æ—¥è¶Šç•Œåˆ¤æ–­
 222   2          {
 223   3            if(TimeArray[2]>31){TimeArray[2]=1;}//å¤§æœˆ
 224   3          }
 225   2          else if(TimeArray[1]==4 || TimeArray[1]==6 || TimeArray[1]==9 || TimeArray[1]==11)
 226   2          {
 227   3            if(TimeArray[2]>30){TimeArray[2]=1;}//å°æœˆ
 228   3          }
 229   2          else if(TimeArray[1]==2)
 230   2          {
 231   3            if(TimeArray[0]%4==0)
 232   3            {
 233   4              if(TimeArray[2]>29){TimeArray[2]=1;}//é—°å¹´2æœˆ
 234   4            }
 235   3            else
 236   3            {
 237   4              if(TimeArray[2]>28){TimeArray[2]=1;}//å¹³å¹´2æœˆ
C51 COMPILER V9.60.7.0   MAIN                                                              01/01/2025 20:09:50 PAGE 5   

 238   4            }
 239   3          }
 240   2          TimeArray[6] = CalculateWeekday(TimeArray[0], TimeArray[1], TimeArray[2]);//æ›´æ–°æ˜ŸæœŸ
 241   2          if(TimeArray[3]>23){TimeArray[3]=0;}//æ—¶è¶Šç•Œåˆ¤æ–­
 242   2          if(TimeArray[4]>59){TimeArray[4]=0;}//åˆ†è¶Šç•Œåˆ¤æ–­
 243   2          if(TimeArray[5]>59){TimeArray[5]=0;}//ç§’è¶Šç•Œåˆ¤æ–­
 244   2          if(TimeArray[6]>6){TimeArray[6]=0;}//æ˜ŸæœŸè¶Šç•Œåˆ¤æ–­
 245   2      
 246   2        }
 247   1        if(KeyNum==4)//æŒ‰é”®4æŒ‰ä¸‹
 248   1        {
 249   2          TimeArray[*SelectPtr]--;//æ—¶é—´è®¾ç½®ä½æ•°å€¼å‡1
 250   2          if(TimeArray[0]<0){TimeArray[0]=99;}//å¹´è¶Šç•Œåˆ¤æ–­
 251   2          if(TimeArray[1]<1){TimeArray[1]=12;}//æœˆè¶Šç•Œåˆ¤æ–­
 252   2          if( TimeArray[1]==1 || TimeArray[1]==3 || TimeArray[1]==5 || TimeArray[1]==7 || 
 253   2            TimeArray[1]==8 || TimeArray[1]==10 || TimeArray[1]==12)//æ—¥è¶Šç•Œåˆ¤æ–­
 254   2          {
 255   3            if(TimeArray[2]<1){TimeArray[2]=31;}//å¤§æœˆ
 256   3            if(TimeArray[2]>31){TimeArray[2]=1;}
 257   3          }
 258   2          else if(TimeArray[1]==4 || TimeArray[1]==6 || TimeArray[1]==9 || TimeArray[1]==11)
 259   2          {
 260   3            if(TimeArray[2]<1){TimeArray[2]=30;}//å°æœˆ
 261   3            if(TimeArray[2]>30){TimeArray[2]=1;}
 262   3          }
 263   2          else if(TimeArray[1]==2)
 264   2          {
 265   3            if(TimeArray[0]%4==0)
 266   3            {
 267   4              if(TimeArray[2]<1){TimeArray[2]=29;}//é—°å¹´2æœˆ
 268   4              if(TimeArray[2]>29){TimeArray[2]=1;}
 269   4            }
 270   3            else
 271   3            {
 272   4              if(TimeArray[2]<1){TimeArray[2]=28;}//å¹³å¹´2æœˆ
 273   4              if(TimeArray[2]>28){TimeArray[2]=1;}
 274   4            }
 275   3          }
 276   2          if(TimeArray[3]<0){TimeArray[3]=23;}//æ—¶è¶Šç•Œåˆ¤æ–­
 277   2          if(TimeArray[4]<0){TimeArray[4]=59;}//åˆ†è¶Šç•Œåˆ¤æ–­
 278   2          if(TimeArray[5]<0){TimeArray[5]=59;}//ç§’è¶Šç•Œåˆ¤æ–­
 279   2          if(TimeArray[6]<0){TimeArray[6]=6;}//æ˜ŸæœŸè¶Šç•Œåˆ¤æ–­
 280   2          TimeArray[6] = CalculateWeekday(TimeArray[0], TimeArray[1], TimeArray[2]);
 281   2        }
 282   1        //æ›´æ–°æ˜¾ç¤ºï¼Œæ ¹æ®TimeSetSelectå’ŒTimeSetFlashFlagåˆ¤æ–­å¯å®Œæˆé—ªçƒåŠŸèƒ½
 283   1        if(*SelectPtr==0 && TimeSetFlashFlag==1){LCD_ShowString(1,1,"  ");}
 284   1        else {LCD_ShowNum(1,1,TimeArray[0],2);}
 285   1        if(*SelectPtr==1 && TimeSetFlashFlag==1){LCD_ShowString(1,4,"  ");}
 286   1        else {LCD_ShowNum(1,4,TimeArray[1],2);}
 287   1        if(*SelectPtr==2 && TimeSetFlashFlag==1){LCD_ShowString(1,7,"  ");}
 288   1        else {LCD_ShowNum(1,7,TimeArray[2],2);}
 289   1        if(*SelectPtr==3 && TimeSetFlashFlag==1){LCD_ShowString(2,1,"  ");}
 290   1        else {LCD_ShowNum(2,1,TimeArray[3],2);}
 291   1        if(*SelectPtr==4 && TimeSetFlashFlag==1){LCD_ShowString(2,4,"  ");}
 292   1        else {LCD_ShowNum(2,4,TimeArray[4],2);}
 293   1        if(*SelectPtr==5 && TimeSetFlashFlag==1){LCD_ShowString(2,7,"  ");}
 294   1        else {LCD_ShowNum(2,7,TimeArray[5],2);}
 295   1        if(*SelectPtr==6 && TimeSetFlashFlag==1){LCD_ShowString(2,12,"  ");}
 296   1        else {LCD_ShowNum(2,12,TimeArray[6],1);}
 297   1      }
 298          
 299          void Timer0_Routine() interrupt 1
C51 COMPILER V9.60.7.0   MAIN                                                              01/01/2025 20:09:50 PAGE 6   

 300          {
 301   1        static unsigned int T0Count;
 302   1        static unsigned char station_toggle;
 303   1        TL0 = 0x18;   //è®¾ç½®å®šæ—¶åˆå€¼
 304   1        TH0 = 0xFC;   //è®¾ç½®å®šæ—¶åˆå€¼
 305   1        T0Count++;
 306   1        if(T0Count>=100)//æ¯100msè¿›å…¥ä¸€æ¬¡
 307   1        { 
 308   2          T0Count=0;
 309   2          station_toggle++;
 310   2          if (station_toggle>=4)
 311   2          {
 312   3            station_toggle = 0;
 313   3            TimeSetFlashFlag=!TimeSetFlashFlag;//é—ªçƒæ ‡å¿—ä½å–å
 314   3          }
 315   2          if (StopwatchState) {
 316   3                  StopwatchTime += 100; // å¢åŠ  100ms
 317   3              }
 318   2        }
 319   1      }
 320          //LCD1602å†™å‘½ä»¤
 321          void LCD_WriteCommand(unsigned char Command)
 322          {
 323   1        LCD_RS=0;
 324   1        LCD_RW=0;
 325   1        LCD_DataPort=Command;
 326   1        LCD_EN=1;
 327   1        Delay(1);
 328   1        LCD_EN=0;
 329   1        Delay(1);
 330   1      }
 331          //LCD1602å†™æ•°æ®
 332          void LCD_WriteData(unsigned char Data)
 333          {
 334   1        LCD_RS=1;
 335   1        LCD_RW=0;
 336   1        LCD_DataPort=Data;
 337   1        LCD_EN=1;
 338   1        Delay(1);
 339   1        LCD_EN=0;
 340   1        Delay(1);
 341   1      }
 342          //LCD1602è®¾ç½®å…‰æ ‡ä½ç½®
 343          void LCD_SetCursor(unsigned char Line,unsigned char Column)
 344          {
 345   1        if(Line==1)
 346   1        {
 347   2          LCD_WriteCommand(0x80|(Column-1));
 348   2        }
 349   1        else if(Line==2)
 350   1        {
 351   2          LCD_WriteCommand(0x80|(Column-1+0x40));
 352   2        }
 353   1      }
 354          //LCD1602åˆå§‹åŒ–å‡½æ•°
 355          void LCD_Init()
 356          {
 357   1        LCD_WriteCommand(0x38);//å…«ä½æ•°æ®æ¥å£ï¼Œä¸¤è¡Œæ˜¾ç¤ºï¼Œ5*7ç‚¹é˜µ
 358   1        LCD_WriteCommand(0x0c);//æ˜¾ç¤ºå¼€ï¼Œå…‰æ ‡å…³ï¼Œé—ªçƒå…³
 359   1        LCD_WriteCommand(0x06);//æ•°æ®è¯»å†™æ“ä½œåï¼Œå…‰æ ‡è‡ªåŠ¨åŠ ä¸€ï¼Œç”»é¢ä¸åŠ¨
 360   1        LCD_WriteCommand(0x01);//å…‰æ ‡å¤ä½ï¼Œæ¸…å±
 361   1      }
C51 COMPILER V9.60.7.0   MAIN                                                              01/01/2025 20:09:50 PAGE 7   

 362          //åœ¨LCD1602æŒ‡å®šä½ç½®ä¸Šæ˜¾ç¤ºä¸€ä¸ªå­—ç¬¦
 363          void LCD_ShowChar(unsigned char Line,unsigned char Column,char Char)
 364          {
 365   1        LCD_SetCursor(Line,Column);
 366   1        LCD_WriteData(Char);
 367   1      }
 368          //åœ¨LCD1602æŒ‡å®šä½ç½®å¼€å§‹æ˜¾ç¤ºæ‰€ç»™å­—ç¬¦ä¸²
 369          void LCD_ShowString(unsigned char Line,unsigned char Column,char *String)
 370          {
 371   1        unsigned char i;
 372   1        LCD_SetCursor(Line,Column);
 373   1        for(i=0;String[i]!='\0';i++)
 374   1        {
 375   2          LCD_WriteData(String[i]);
 376   2        }
 377   1      }
 378          // åœ¨LCD1602æŒ‡å®šä½ç½®å¼€å§‹æ˜¾ç¤ºæ‰€ç»™æ•°å­—
 379          void LCD_ShowNum(unsigned char Line,unsigned char Column,unsigned int Number,unsigned char Length)
 380          {
 381   1        unsigned char i;
 382   1        LCD_SetCursor(Line,Column);
 383   1        for(i=Length;i>0;i--)
 384   1        {
 385   2          LCD_WriteData(Number/LCD_Pow(10,i-1)%10+'0');
 386   2        }
 387   1      }
 388          //LCD1602ä¹˜æ–¹è¿ç®—
 389          int LCD_Pow(int X,int Y)
 390          {
 391   1        unsigned char i;
 392   1        int Result=1;
 393   1        for(i=0;i<Y;i++)
 394   1        {
 395   2          Result*=X;
 396   2        }
 397   1        return Result;
 398   1      }
 399          //ç‹¬ç«‹æŒ‰é”®å‡½æ•°å®ç°
 400          unsigned char Key()
 401          {
 402   1        unsigned char KeyNumber=0;
 403   1        if(P3_0==0){Delay(20);while(P3_0==0);Delay(20);KeyNumber=1;}
 404   1        if(P3_1==0){Delay(20);while(P3_1==0);Delay(20);KeyNumber=2;}
 405   1        if(P3_2==0){Delay(20);while(P3_2==0);Delay(20);KeyNumber=3;}
 406   1        if(P3_3==0){Delay(20);while(P3_3==0);Delay(20);KeyNumber=4;}
 407   1        if(P1_0==0){Delay(20);while(P1_0==0);Delay(20);KeyNumber=5;}
 408   1        if(P1_1==0){Delay(20);while(P1_1==0);Delay(20);KeyNumber=6;}
 409   1        if(P1_2==0){Delay(20);while(P1_2==0);Delay(20);KeyNumber=7;}
 410   1        if(P1_3==0){Delay(20);while(P1_3==0);Delay(20);KeyNumber=8;}
 411   1        return KeyNumber;
 412   1      }
 413          //å»¶æ—¶å‡½æ•°å®ç°
 414          void Delay(unsigned int xms)
 415          {
 416   1        unsigned char i, j;
 417   1        while(xms--)
 418   1        {
 419   2          i = 2;
 420   2          j = 239;
 421   2          do
 422   2          {
 423   3            while (--j);
C51 COMPILER V9.60.7.0   MAIN                                                              01/01/2025 20:09:50 PAGE 8   

 424   3          } while (--i);
 425   2        }
 426   1      }
 427          //T0å®šæ—¶å™¨åˆå§‹åŒ–å‡½æ•°å®ç°
 428          void Timer0Init(void)
 429          {
 430   1        TMOD &= 0xF0;   //è®¾ç½®å®šæ—¶å™¨æ¨¡å¼
 431   1        TMOD |= 0x01;   //è®¾ç½®å®šæ—¶å™¨æ¨¡å¼
 432   1        TL0 = 0x18;   //è®¾ç½®å®šæ—¶åˆå€¼
 433   1        TH0 = 0xFC;   //è®¾ç½®å®šæ—¶åˆå€¼
 434   1        TF0 = 0;    //æ¸…é™¤TF0æ ‡å¿—
 435   1        TR0 = 1;    //å®šæ—¶å™¨0å¼€å§‹è®¡æ—¶
 436   1        ET0=1;
 437   1        EA=1;
 438   1        PT0=0;
 439   1      }
 440          //DS1302åˆå§‹åŒ–
 441          void DS1302_Init(void)
 442          {
 443   1        DS1302_CE=0;
 444   1        DS1302_SCLK=0;
 445   1      }
 446          //DS1302å†™ä¸€ä¸ªå­—èŠ‚
 447          void DS1302_WriteByte(unsigned char Command,Data)
 448          {
 449   1        unsigned char i;
 450   1        DS1302_CE=1;
 451   1        for(i=0;i<8;i++)
 452   1        {
 453   2          DS1302_IO=Command&(0x01<<i);
 454   2          DS1302_SCLK=1;
 455   2          DS1302_SCLK=0;
 456   2        }
 457   1        for(i=0;i<8;i++)
 458   1        {
 459   2          DS1302_IO=Data&(0x01<<i);
 460   2          DS1302_SCLK=1;
 461   2          DS1302_SCLK=0;
 462   2        }
 463   1        DS1302_CE=0;
 464   1      }
 465          //DS1302è¯»ä¸€ä¸ªå­—èŠ‚
 466          unsigned char DS1302_ReadByte(unsigned char Command)
 467          {
 468   1        unsigned char i,Data=0x00;
 469   1        Command|=0x01;  //å°†æŒ‡ä»¤è½¬æ¢ä¸ºè¯»æŒ‡ä»¤
 470   1        DS1302_CE=1;
 471   1        for(i=0;i<8;i++)
 472   1        {
 473   2          DS1302_IO=Command&(0x01<<i);
 474   2          DS1302_SCLK=0;
 475   2          DS1302_SCLK=1;
 476   2        }
 477   1        for(i=0;i<8;i++)
 478   1        {
 479   2          DS1302_SCLK=1;
 480   2          DS1302_SCLK=0;
 481   2          if(DS1302_IO){Data|=(0x01<<i);}
 482   2        }
 483   1        DS1302_CE=0;
 484   1        DS1302_IO=0;  //è¯»å–åå°†IOè®¾ç½®ä¸º0ï¼Œå¦åˆ™è¯»å‡ºçš„æ•°æ®ä¼šå‡ºé”™
 485   1        return Data;
C51 COMPILER V9.60.7.0   MAIN                                                              01/01/2025 20:09:50 PAGE 9   

 486   1      }
 487          //DS1302è®¾ç½®æ—¶é—´  
 488          void DS1302_SetTime(void)
 489          {
 490   1        DS1302_WriteByte(DS1302_WP,0x00);
 491   1        DS1302_WriteByte(DS1302_YEAR,DS1302_Time[0]/10*16+DS1302_Time[0]%10);//åè¿›åˆ¶è½¬BCDç åå†™å…¥
 492   1        DS1302_WriteByte(DS1302_MONTH,DS1302_Time[1]/10*16+DS1302_Time[1]%10);
 493   1        DS1302_WriteByte(DS1302_DATE,DS1302_Time[2]/10*16+DS1302_Time[2]%10);
 494   1        DS1302_WriteByte(DS1302_HOUR,DS1302_Time[3]/10*16+DS1302_Time[3]%10);
 495   1        DS1302_WriteByte(DS1302_MINUTE,DS1302_Time[4]/10*16+DS1302_Time[4]%10);
 496   1        DS1302_WriteByte(DS1302_SECOND,DS1302_Time[5]/10*16+DS1302_Time[5]%10);
 497   1        DS1302_WriteByte(DS1302_DAY,DS1302_Time[6]/10*16+DS1302_Time[6]%10);
 498   1        DS1302_WriteByte(DS1302_WP,0x80);
 499   1      }
 500          //DS1302è¯»å–æ—¶é—´
 501          void DS1302_ReadTime(void)
 502          {
 503   1        unsigned char Temp;
 504   1        Temp=DS1302_ReadByte(DS1302_YEAR);
 505   1        DS1302_Time[0]=Temp/16*10+Temp%16;//BCDç è½¬åè¿›åˆ¶åè¯»å–
 506   1        Temp=DS1302_ReadByte(DS1302_MONTH);
 507   1        DS1302_Time[1]=Temp/16*10+Temp%16;
 508   1        Temp=DS1302_ReadByte(DS1302_DATE);
 509   1        DS1302_Time[2]=Temp/16*10+Temp%16;
 510   1        Temp=DS1302_ReadByte(DS1302_HOUR);
 511   1        DS1302_Time[3]=Temp/16*10+Temp%16;
 512   1        Temp=DS1302_ReadByte(DS1302_MINUTE);
 513   1        DS1302_Time[4]=Temp/16*10+Temp%16;
 514   1        Temp=DS1302_ReadByte(DS1302_SECOND);
 515   1        DS1302_Time[5]=Temp/16*10+Temp%16;
 516   1        Temp=DS1302_ReadByte(DS1302_DAY);
 517   1        DS1302_Time[6]=Temp/16*10+Temp%16;
 518   1      }
 519          //é—¹é’ŸåŠŸèƒ½å‡½æ•°å®ç°
 520          void CheckAlarm() {
 521   1          if (DS1302_Time[0] == AlarmTime[0] && 
 522   1              DS1302_Time[1] == AlarmTime[1] && 
 523   1              DS1302_Time[2] == AlarmTime[2] &&
 524   1          DS1302_Time[3] == AlarmTime[3] &&
 525   1          DS1302_Time[4] == AlarmTime[4] &&
 526   1          DS1302_Time[5] == AlarmTime[5] &&
 527   1          DS1302_Time[6] == AlarmTime[6]) {
 528   2              AlarmFlag = 1; // è§¦å‘é—¹é’Ÿ
 529   2          BuzzerState = 1;
 530   2          }else {
 531   2              AlarmFlag = 0; // å…³é—­é—¹é’Ÿ
 532   2          }
 533   1      }
 534          //18B20å‡½æ•°å®ç°
 535          void DS18B20_Init(void){
 536   1        DS18B20_ConvertT();   //ä¸Šç”µå…ˆè½¬æ¢ä¸€æ¬¡æ¸©åº¦ï¼Œé˜²æ­¢ç¬¬ä¸€æ¬¡è¯»æ•°æ®é”™è¯¯
 537   1        Delay(1000);      //ç­‰å¾…è½¬æ¢å®Œæˆ
 538   1      }
 539          //è½¬æ¢æ¸©åº¦
 540          void DS18B20_ConvertT(void)
 541          {
 542   1        OneWire_Init();
 543   1        OneWire_SendByte(DS18B20_SKIP_ROM);
 544   1        OneWire_SendByte(DS18B20_CONVERT_T);
 545   1      }
 546          //è¯»å–æ¸©åº¦
 547          float DS18B20_ReadT(void)
C51 COMPILER V9.60.7.0   MAIN                                                              01/01/2025 20:09:50 PAGE 10  

 548          {
 549   1        unsigned char TLSB,TMSB;
 550   1        int Temp;
 551   1        float T;
 552   1        OneWire_Init();
 553   1        OneWire_SendByte(DS18B20_SKIP_ROM);
 554   1        OneWire_SendByte(DS18B20_READ_SCRATCHPAD);
 555   1        TLSB=OneWire_ReceiveByte();
 556   1        TMSB=OneWire_ReceiveByte();
 557   1        Temp=(TMSB<<8)|TLSB;
 558   1        T=Temp/16.0;
 559   1        return T;
 560   1      }
 561          //å•æ€»çº¿å‡½æ•°å®ç°
 562          unsigned char OneWire_Init(void)
 563          {
 564   1        unsigned char i;
 565   1        unsigned char AckBit;
 566   1        OneWire_DQ=1;
 567   1        OneWire_DQ=0;
 568   1        i = 247;while (--i);    //Delay 500us
 569   1        OneWire_DQ=1;
 570   1        i = 32;while (--i);     //Delay 70us
 571   1        AckBit=OneWire_DQ;
 572   1        i = 247;while (--i);    //Delay 500us
 573   1        return AckBit;
 574   1      }
 575          //å•æ€»çº¿å‘é€ä¸€ä½
 576          void OneWire_SendBit(unsigned char Bit)
 577          {
 578   1        unsigned char i;
 579   1        OneWire_DQ=0;
 580   1        i = 4;while (--i);      //Delay 10us
 581   1        OneWire_DQ=Bit;
 582   1        i = 24;while (--i);     //Delay 50us
 583   1        OneWire_DQ=1;
 584   1      }
 585          //å•æ€»çº¿æ¥æ”¶ä¸€ä½
 586          unsigned char OneWire_ReceiveBit(void)
 587          {
 588   1        unsigned char i;
 589   1        unsigned char Bit;
 590   1        OneWire_DQ=0;
 591   1        i = 2;while (--i);      //Delay 5us
 592   1        OneWire_DQ=1;
 593   1        i = 2;while (--i);      //Delay 5us
 594   1        Bit=OneWire_DQ;
 595   1        i = 24;while (--i);     //Delay 50us
 596   1        return Bit;
 597   1      }
 598          //å•æ€»çº¿å‘é€ä¸€ä¸ªå­—èŠ‚
 599          void OneWire_SendByte(unsigned char Byte)
 600          {
 601   1        unsigned char i;
 602   1        for(i=0;i<8;i++)
 603   1        {
 604   2          OneWire_SendBit(Byte&(0x01<<i));
 605   2        }
 606   1      }
 607          //å•æ€»çº¿æ¥æ”¶ä¸€ä¸ªå­—èŠ‚
 608          unsigned char OneWire_ReceiveByte(void)
 609          {
C51 COMPILER V9.60.7.0   MAIN                                                              01/01/2025 20:09:50 PAGE 11  

 610   1        unsigned char i;
 611   1        unsigned char Byte=0x00;
 612   1        for(i=0;i<8;i++)
 613   1        {
 614   2          if(OneWire_ReceiveBit()){Byte|=(0x01<<i);}
 615   2        }
 616   1        return Byte;
 617   1      }
 618          //æ˜ŸæœŸè®¡ç®—å‡½æ•°å®ç°
 619          unsigned char CalculateWeekday(int year, int month, int day) {
 620   1        unsigned char weekday;
 621   1          if (month < 3) {
 622   2              month += 12;
 623   2              year--;
 624   2          }
 625   1          weekday = (day + 2 * month + 3 * (month + 1) / 5 + year + year / 4 - year / 100 + year / 400) % 7;
 626   1          return (weekday + 1);
 627   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   3595    ----
   CONSTANT SIZE    =     42    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     32      33
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
